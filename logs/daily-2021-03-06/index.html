<!DOCTYPE html>
<html lang="ja"><meta charset="utf-8"><meta name="generator" content="Hugo 0.79.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Daily/2021/03/06&nbsp;&ndash;&nbsp;三日坊主。</title><link rel="stylesheet" href="/css/core.min.f50770753e7b4a1cf823b8241022bf5a6908ecbc3cfcba59bfb76af28f94cceda372fd3dad1f0b6fb6592fd79f9fc1f3.css" integrity="sha384-9QdwdT57Shz4I7gkECK/WmkI7Lw8/LpZv7dq8o&#43;UzO2jcv09rR8Lb7ZZL9efn8Hz"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Daily/2021/03/06" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">三日坊主。</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">カテゴリー</a><a class="nav item" href="/tags/">タグ</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Daily/2021/03/06</h1><p class="article date">2021-03-06</p></section><article class="article markdown-body"><h1 id="mac-book-air-の-m1-が来た">Mac Book Air の M1 が来た！</h1>
<p>現状は特段困ってない。<br>
M1 の速さを享受するために無理矢理 M1 対応版を使うことはしていない。</p>
<p>docker は rosetta2 上で動かないので、それはドキドキしたけど、M1 対応の preview 版があるので一旦大丈夫そう。<br>
様子見る。</p>
<p>Go は 1.16 でネイティブ対応したとのこと。さすが嬉しい。</p>
<p>brew で install するとき結構これ求められる。</p>
<pre><code>$ brew install protobuf
Error: Cannot install under Rosetta 2 in ARM default prefix (/opt/homebrew)!
To rerun under ARM use:
    arch -arm64 brew install ...
To install under x86_64, install Homebrew into /usr/local.
</code></pre><h1 id="go-116-から追加された-embed-について">Go 1.16 から追加された embed について</h1>
<p>PC の入れ替えに引きづられて Go を 1.16 にしたので、メールのテンプレートを embed で読み出すようにしてみる。こんな感じ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
	<span style="color:#75715e">// for embed template text
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;embed&#34;</span>
)

<span style="color:#75715e">//go:embed templates/mail.txt
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mailTemplate</span> <span style="color:#66d9ef">string</span>
</code></pre></div><p>embed の import 忘れそう。。と、コメントを差し込まないと go-lint で警告が出る。_ での import は基本的に main か test で、ということらしい。</p>
<p>これによって、ビルドのときに成果物に予め含んでおいてくれる。
存在しないファイルを指定したりするとビルド時に落としてくれる。</p>
<p>以前は実行時に読み込むために、Dockerfile でテンプレートファイルを個別に ADD するようにしていたのでだいぶ楽だし、変に壊れる必要もないのが嬉しい。</p>
<h1 id="go-mod-vendor-がすべてのファイルを-vendor-配下においてくれない問題">go mod vendor がすべてのファイルを vendor 配下においてくれない問題</h1>
<p>PC が変わって環境構築してるときに、vend コマンドが見つからなかった。</p>
<p>Makefile に突っ込んどいたと思ったんだけど忘れてて、あれどれだっけな、、と思って必死に探した。これ。</p>
<pre><code>go get github.com/nomad-software/vend
</code></pre><p>と思ったけど、なんか前も書いたなと思って grep したら <a href="https://sat8bit.github.io/logs/daily-2021-01-20/"target="_blank" rel="noopener noreferrer">2021/01/20</a>
 にログに書いてた。書いててよかった。</p>
<p>ついでに protoc もなかった。これ。</p>
<p><a href="http://google.github.io/proto-lens/installing-protoc.html">http://google.github.io/proto-lens/installing-protoc.html</a></p>
<p>protoc-gen-** もない。</p>
<p><a href="https://grpc.io/docs/languages/go/quickstart/">https://grpc.io/docs/languages/go/quickstart/</a><br>
<a href="https://github.com/grpc-ecosystem/grpc-gateway">https://github.com/grpc-ecosystem/grpc-gateway</a></p>
<p>この辺まとめるとこうなる。</p>
<pre><code>$ go install \
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway \
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2 \
    google.golang.org/protobuf/cmd/protoc-gen-go \
    google.golang.org/grpc/cmd/protoc-gen-go-grpc \
    github.com/mwitkow/go-proto-validators/protoc-gen-govalidators
</code></pre><h1 id="その他">その他</h1>
<h1 id="next">Next</h1>
</article><section class="article labels"><a class="tag" href=/tags/logs/>logs</a></section><section class="article author"><p class="name">Satoshi Koizumi</p><div class="details"><a class="item" href="https://github.com/sat8bit" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;sat8bit</a><a class="item" href="https://twitter.com/sat8bit" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-twitter"></span>&nbsp;@sat8bit</a><a class="item" href="mailto:sat8bit@mail.com" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-email"></span>&nbsp;sat8bit@mail.com</a></div>
</section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/logs/daily-2021-03-07/"><span class="iconfont icon-article"></span>Daily/2021/03/07</a></p><p><a class="link" href="/logs/daily-2021-02-08/"><span class="iconfont icon-article"></span>Daily/2021/02/08</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">三日坊主。</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div>
</section>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-62G1T8FBSZ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>

</html>