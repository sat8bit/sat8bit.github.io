<!DOCTYPE html>
<html lang="ja"><meta charset="utf-8"><meta name="generator" content="Hugo 0.79.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Daily/2021/01/20&nbsp;&ndash;&nbsp;三日坊主。</title><link rel="stylesheet" href="/css/core.min.f50770753e7b4a1cf823b8241022bf5a6908ecbc3cfcba59bfb76af28f94cceda372fd3dad1f0b6fb6592fd79f9fc1f3.css" integrity="sha384-9QdwdT57Shz4I7gkECK/WmkI7Lw8/LpZv7dq8o&#43;UzO2jcv09rR8Lb7ZZL9efn8Hz"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Daily/2021/01/20" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">三日坊主。</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">カテゴリー</a><a class="nav item" href="/tags/">タグ</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Daily/2021/01/20</h1><p class="article date">2021-01-20</p></section><article class="article markdown-body"><h1 id="todo">Todo</h1>
<table>
<thead>
<tr>
<th>Todo</th>
<th>Done</th>
</tr>
</thead>
<tbody>
<tr>
<td>protobuf で go mod vendor 使えばいいんじゃないか？を見てみる</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="log">Log</h1>
<h2 id="protobuf-で-go-mod-vendor-使えばいいんじゃないかを見てみる">protobuf で go mod vendor 使えばいいんじゃないか？を見てみる</h2>
<p>何も考えずに <code>$GOROOT/src</code> をインクルードパスに指定してたけど、どのバージョンに依存してるかよくわからない状態だったので <code>Go Module</code> 使って管理したほうが良さそう。</p>
<p>そして <code>go mod vendor</code> を使えば、インクルードパスも <code>vendor</code> にできるんじゃないか、ということでやってみる。</p>
<p>まず import を github.com から書くのをやめる。
外部の import が github.com から指定だったから揃えてみたけど結果的に全然良くなかった。</p>
<p>ここみるのが良さそう。</p>
<p><a href="https://github.com/grpc-ecosystem/grpc-gateway">https://github.com/grpc-ecosystem/grpc-gateway</a></p>
<p>protoc のプラグインを <code>go.mod</code> に追加するために <code>tools/dependencies.go</code> を作る。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
        <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway&#34;</span>
        <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2&#34;</span>
        <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/mwitkow/go-proto-validators&#34;</span>
        <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;google.golang.org/grpc/cmd/protoc-gen-go-grpc&#34;</span>
        <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;google.golang.org/protobuf/cmd/protoc-gen-go&#34;</span>
)
</code></pre></div><p><code>go mod init &amp;&amp; go mod tidy</code> をすると、<code>go.mod</code> <code>go.sum</code> ができる。</p>
<p>そして <code>go mod vendor</code> を実行すると、必要なファイルが vendor 配下に落ちてくる。</p>
<p><code>grpc-gateway</code> の README によると、以下の import を proto ファイルに追加するらしいが</p>
<pre><code>import &quot;google/api/annotations.proto&quot;;
</code></pre><p>何度やってもこうなる。</p>
<pre><code>Import &quot;googleapis/google/api/annotations.proto&quot; was not found or had errors.
</code></pre><p>インクルードパスにないからね、そりゃそうだよねって思ってたら、ちゃんと書いてあった。</p>
<blockquote>
<p>You will need to provide the required third party protobuf files to the protoc compiler. They are included in this repo under the third_party/googleapis folder, and we recommend copying them into your protoc generation file structure. If you&rsquo;ve structured your proto files according to something like the Buf style guide, you could copy the files into a top-level ./google folder.</p>
</blockquote>
<p>英語パッと読めないから気づくまで時間かかってしまったよ。。</p>
<p>現在 protobuf リポジトリは以下のような構造になっているので、<code>proto</code> 配下にコピーする。</p>
<pre><code>repo
├── proto
│   ├── google &lt;- ここに置く
│   ├── pkgA
│   │   ├── a_service1.proto
│   │   └── a_service2.proto
│   ├── pkgB
│   │   ├── b_service1.proto
│   │   └── b_service2.proto
│   └── pkgC
│       ├── c_service1.proto
│       └── c_service2.proto
└── go/
    └── &lt;生成されるファイル&gt;
</code></pre><p>ので vendorからコピーしようとしたら vendor 配下の grpc-gateway に third_party ディレクトリがない・・・</p>
<p><a href="https://github.com/golang/go/issues/26366">https://github.com/golang/go/issues/26366</a></p>
<p>vendor では全てのファイルをとってくるわけではないそう。</p>
<p>上記Issueもまだ結論出ておらず、とりあえず全コピーするコマンド vend を作ってくれたそうなのでこれを使う。</p>
<p><a href="https://github.com/nomad-software/vend">https://github.com/nomad-software/vend</a></p>
<pre><code>vend
cp -R vendor/github.com/grpc-ecosystem/grpc-gateway/v2/third_party/googleapis/google proto
</code></pre><p>これで一旦通せるようになったので、vendor を構築するコマンド達を Makefile にまとめておく。</p>
<pre><code>prepare::
    go get github.com/nomad-software/vend
    vend
    cp -R vendor/github.com/grpc-ecosystem/grpc-gateway/v2/third_party/googleapis/google proto
</code></pre><p>が、openapiv2 を吐き出してるところでエラー。</p>
<p>protoc-gen-openapiv2 の annotation を使ってたんだけど、この行で import が protoc-gen-openapiv2 から指定になってる。</p>
<p><a href="https://github.com/grpc-ecosystem/grpc-gateway/blob/master/protoc-gen-openapiv2/options/annotations.proto#L8">https://github.com/grpc-ecosystem/grpc-gateway/blob/master/protoc-gen-openapiv2/options/annotations.proto#L8</a></p>
<p>この場合は、上の googleapis と同様コピーするか、<code>github.com/grpc-ecosystem/grpc-gateway</code> をインクルードパスに追加するしかないことになる。</p>
<p>そろそろ眠いのでここは一旦要検討。</p>
<h2 id="その他作業中に発生したこと">その他作業中に発生したこと</h2>
<h2 id="next">Next</h2>
<ul>
<li>openapiv2 の問題解決</li>
</ul>
</article><section class="article labels"><a class="tag" href=/tags/logs/>logs</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/logs/daily-2021-01-24/"><span class="iconfont icon-article"></span>Daily/2021/01/24</a></p><p><a class="link" href="/logs/daily-2021-01-19/"><span class="iconfont icon-article"></span>Daily/2021/01/19</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">三日坊主。</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div>
</section>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-62G1T8FBSZ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>

</html>